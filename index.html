<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="MARS: Multi-omics Adapter for Repository Submissions">
  <meta name="keywords" content="MARS,">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    .center {
      position: relative;
      text-align: center;
    }

    .area {
      border-left: 1px solid #dee2e6;


      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;


      text-align: center;
    }

    .uploadarea {
      border: 4px dashed rgb(45, 62, 80);
      filter: alpha(opacity=50);
      -khtml-opacity: 0.5;
      -moz-opacity: 0.5;
      opacity: 0.5;
      height: 20vh;
      background-image: url("./images/download.png");
      background-position: center;
      background-repeat: no-repeat;
      background-size: 64px 64px;

    }

    .uploadarea:hover,
    .uploadarea.dragging,
    .uploadarea.uploading {
      filter: alpha(opacity=100);
      -khtml-opacity: 1;
      -moz-opacity: 1;
      opacity: 1;
    }

    .uploadarea input {
      margin: auto;
      width: 100%;
      height: 100%;

      border: none;
      cursor: pointer;
      opacity: 0;
    }

    .uploadarea input:focus {
      outline: none;
    }
  </style>

  <!--<script src="https://cdn.jsdelivr.net/pyodide/v0.21.3/full/pyodide.js"></script>-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"></script>
  <link href="css/custom.css" rel="stylesheet" />
  <link href="css/bs5-intro-tour.css" rel="stylesheet" />
  <script src="js/bs5-intro-tour.js" type="text/javascript" charset="utf-8"></script>
  <!--script src="js/example.js" type="text/javascript" charset="utf-8"></script-->
  <script src="js/test_json.js"></script>
</head>
</head>

<body>
  <div class="col-12" style="background: rgb(45, 62, 80); height: 3.25rem; margin: 0 0 0 0px; padding: 0 0 0 0; ">
    <a class="" href="https://nfdi4plants.org/" style="">
      <img src="images/logo.png" alt="Logo" width="32" height="32"
        style="position: absolute; margin: 8px 12px 8px 12px; left: 0px; padding-top: 4px;" />
    </a>





    <div class="justify-content-center row d-flex align-items-center"
      style="margin: 0 0 0 0; ; padding: 0 0 0 0; height: 3.25rem;  ">


      <div class="btn-group d-md-none g-0 dropdown col-auto d-flex align-items-center" style="">
        <button type="button" class="btn rounded-0 border-0 g-0 btn-nav " data-bs-toggle="dropdown"
          aria-expanded="false" id="menu">
          Menu &nbsp;
          <a
            style="display: inline-block; color: rgb(79, 179, 217); letter-spacing: 2px; font-size: 1em; transform: scaleX(2); transform-origin: 1 0;">
            ∨ </a>
        </button>
        <ul class="dropdown-menu">
          <li>
            <button id="converter_short" class="dropdown-item d-none" onclick=''>Converter</button>
          </li>
          <li>
            <a id="ghlink_short" class="dropdown-item" href="https://github.com/elixir-europe/MARS">GitHub</a>
          </li>
          <li>
            <a id="us_short" class="dropdown-item" onclick=''>About Us</a>
          </li>

        </ul>
      </div>

      <div class="btn-group d-none g-0 d-md-block dropdown col-auto">
        <button type="button" class="btn border-0 rounded-0 g-0 btn-nav" data-bs-toggle="dropdown" aria-expanded="false"
          id="conversion_tools">
          Menu &nbsp;

          <a
            style="display: inline-block; color: rgb(79, 179, 217); letter-spacing: 2px; font-size: 1em; transform: scaleX(2); transform-origin: 1 0;">
            ∨ </a>
        </button>
        <ul class="dropdown-menu">
          <li>
            <button id="converter_long" class="dropdown-item d-none" onclick=''>Converter</button>
          </li>
          <li>
            <a id="ghlink_long" class="dropdown-item" href="https://github.com/elixir-europe/MARS">GitHub</a>
          </li>
          <li>
            <a id="us_long" class="dropdown-item" href=''>About Us</a>
          </li>

        </ul>
      </div>




    </div>
  </div>

 
  <h1 class="center">MARS: Multi-omics Adapter for Repository Submissions </h1>
  <div class="">
    
    <form id="authForm" class="row justify-content-center">
      <div class="mb-3 col-2">
        <label for="username" class="form-label">ENA Username</label>
        <input type="text" class="form-control" id="username" aria-describedby="usernameHelp">
        <div id="usernameHelp" class="form-text d-none">The user name and password are used for token generation.</div>
      </div>
      <div class="mb-3 col-2">
        <label for="password" class="form-label">Password</label>
        <input type="password" class="form-control" id="password">
      </div>
      <div class="mb-3 form-check d-none">
        <input type="checkbox" class="form-check-input " id="passwordCheck">
        <label class="form-check-label" for="passwordCheck">Check me out</label>
      </div>
      <div class="mb-3 col-2 d-none">
        <label id="tokenHelp" class="form-text">Only collect token if you need.</label>
        <br>
      <button type="submit" id="formSubmit" class="btn btn-primary" aria-describedby="tokenHelp">Collect Token</button>
      
    </div>
    </form>
  </div>
</div>
  <div class="center">

    Test BioSamples submission, click <a href="#" onclick="bstest()">here</a> <br>
    Test ENA submission, click <a href="#" onclick="enatest()">here</a>
    <br>
    <input class="btn btn-primary d-inline d-none" type="file" id="input_json" name="json" multiple />
    <input style="display:none" type="file" id="input_xlsx" name="xlsx" multiple />

    <div class=" area uploadarea " id="importArea" ondragenter="this.className='area uploadarea dragging'"
      ondrop=";DragAndDrop(event)" style="margin:auto; height:30vh; width:50vw">


      <input type="file" id="import" multiple>
    </div><br>
    <button class="btn btn-primary" onclick='document.getElementById("formSubmit").click();checkInput()' style="display:inline" data-bs-toggle="modal" data-bs-target="#cModal"
      id="cModalButton"> Start Submissions </button>
    <div class="d-flex justify-content-center d-none" id="waiting">
      <div class="spinner-grow btn-primary" style="width: 3rem; height: 3rem;" role="status">
        <br>
        <span class="sr-only d-none">Loading...</span>
      </div>
    </div>
    <div style="margin:auto;" id="xml_output">
    </div>
  </div>
  <script type="text/javascript">
    var v_list, csv_content, cleanend_global, token , enaReturn = 0, biosamplesReturn= 0;
    var input_json = 0, input_xlsx;
    var log_backup = console.log;
    var log_messages = [];
    var steps = [{
      title: "Converter and validators",
      content: '<p> Welcome! Our converter can convert an ISA-JSON file to multiple endpoint repositories such as ENA, Metabolites, EGA, EVA'
      //
    }
    ];

    var tour = new Tour(steps); // initialize the guided tour
    //tour.show();
    let output_div = document.getElementById("xml_output");
    function DragAndDrop(e) {
      e.preventDefault();
      let ele = document.getElementById("import");

      ele.files = e.dataTransfer.files;
      var reader = new FileReader(); // File reader to read the file 

      // This event listener will happen when the reader has read the file
      reader.addEventListener('load', function () {
        var result = JSON.parse(reader.result); // Parse the result into an object 
        //console.log("reader.result is : "+reader.result);
        input_json = {"investigation": result};
        testJSON = {"investigation": result};
        //console.log("result is : " + result);

      });

      reader.readAsText(ele.files[0]); // Read the uploaded file
    }

    function checkInput(){
      try{
        const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      if ( document.getElementById("import").files.length == 0 ){alert("There is no input file, the submission will use test file");
      bstest()}else{bstest();
        


      }}catch(e){
        alert("Error, submission not successful, error is" + e)
      }
      
    }

    console.log = function () {
      //log_messages.push.apply(log_messages, arguments);
      log_backup.apply(console, arguments);
      output_div.innerText = log_messages.join('\r\n');
    };
    const input1 = document.getElementById("import");
    input1.addEventListener("change", handleFiles1, false);

    function findValues(obj, key){
        return findValuesHelper(obj, key, []);
      }

    function findValuesHelper(obj, key, list) {
      if (!obj) return list;
      if (obj instanceof Array) {
        for (var i in obj) {
            list = list.concat(findValuesHelper(obj[i], key, []));
        }
        return list;
      }
      if (obj[key]) list.push(obj[key]);

      if ((typeof obj == "object") && (obj !== null) ){
        var children = Object.keys(obj);
        if (children.length > 0){
          for (i = 0; i < children.length; i++ ){
              
              if ((children[i] == "value")&& ((typeof obj["value"] =="string" )|| (typeof obj["value"] =="number"))) {
                if ((children[i-1] == "category")||(children[i-1] == "category") ){
                  const oldValue = obj["value"];
                  obj["value"] = { }
                  obj["value"].annotationValue = oldValue;
                  obj["value"].termAccession= "";
                  obj["value"].termSource= "";
                  }

                }


                list = list.concat(findValuesHelper(obj[children[i]], key, []));
              }
              
          }
        }
      
      return list;
    }

    function handleFiles1() {

      if (this.files.length > 0) {
        var reader = new FileReader(); // File reader to read the file 

        // This event listener will happen when the reader has read the file
        reader.addEventListener('load', function () {
          var result   = JSON.parse(reader.result); // Parse the result into an object 
          //console.log("reader.result is : "+reader.result);
          //input_json = {"investigation": result};
          //testJSON = {"investigation": result};
          testJSON= result;
          // testJSON.investigation.studies.forEach((ele)=>{Object.values(ele.materials).forEach((ele2)=>{console.log(findValues(ele2, "value"))})});
          // testJSON.investigation.studies.forEach((ele)=>{Object.values(ele.processSequence).forEach((ele2)=>{console.log(findValues(ele2, "value"))})});
          // testJSON.investigation.studies.forEach((ele)=>{Object.values(ele.assays).forEach((ele2)=>{console.log(findValues(ele2, "value"))})});
          //console.log("result is : " + result);


        });

        reader.readAsText(this.files[0]); // Read the uploaded file

      } else {

        window.alert("no file is selected to import");

      };
    }


    function getToken(){

      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      // Construct the request body
      var requestBody = {
        authRealms: ['ENA'],
        password: password,
        username: username
      };
      
      // Send the POST request using Fetch API
      fetch('https://wwwdev.ebi.ac.uk/ena/submit/webin/auth/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      })
      .then((response) => response.text())
      .then(text => {
        console.log('Response:', text);
        token = text;
        document.getElementById("tokenText").innerText=token;
        document.getElementById("tokenStatus").innerText="Returned";
        bsSubmit(testJSON);
        //document.getElementById("status_modal_button").click();
        // Handle the response here
      })
      .catch(error => {
        console.error('Error:', error);
        // Handle errors here
      });

    }

    function tokenButton(){

      document.getElementById('authForm').addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent the default form submission
      
      // Get the username and password from the input fields

    });
  }


   
    window.onload = (event) =>{

      tokenButton();

    }

    function bstest(){
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      document.getElementById("formSubmit").click();
      getToken();
      
      

    }

    function enatest(){
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      enaSubmit(username, password, testJSON);

    }

    function enaSubmit(name, password, json){
        json = 
        fetch('https://ena.cplantbox.com/isaena/submit?webinUserName='+name+'&webinPassword='+password, {
          method: 'POST',
          //mode: 'cors',
          headers: {
            
            'Content-Type': 'application/json',
            'accept': '*/*'
          },
          body: biosamplesReturn || JSON.stringify(json)
        })
        .then((response) => response.text())
        .then(data => {
          console.log('Success: ', data);
          enaReturn = data;
          document.getElementById("enaStatus").innerText="Returned";
          document.getElementById("enaText").innerText=enaReturn;
              document.getElementById("status_modal_button").click();

        })
        .catch(error => {
          alert("ENA submission failed, error is " + error+". Please check your username and password");
          console.error('Error:', error);

        });

};


function bsSubmit( json){
      
      const fulltoken = "https://biosamples.cplantbox.com/isabiosamples/submit?webinjwt="+ token;
      fetch( fulltoken , {
        method: 'POST',
        //mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json',
          'accept': '*/*'
        },
        body: JSON.stringify(json)
      })
      .then((response) => response.text())
      .then(data => {
        console.log('Success: ', data);
        biosamplesReturn = data;
        document.getElementById("biosamplesStatus").innerText="Returned";
        document.getElementById("biosamplesText").innerText=biosamplesReturn;
            document.getElementById("status_modal_button").click();

      })
      .catch(error => {
        alert("BioSamples submission failed, error is " + error+". Please check your jwt token");
        console.error('Error:', error);
      });

    };
  </script>
  <script type="module">
    //import { EnaBroker } from "./js/broker/ena/ena.broker.js";
    //import { MetabolightsBroker } from "./js/broker/metabolights/metabolights.broker.js";
    //import { BiosamplesService } from "./js/broker/biosamples/biosamples.service.js";
    //import { BrokerType } from "./js/broker/broker.type.js";
    //import { BrokerStatus } from "./js/broker/status.type.js";

    function submit(repository, isaJson) {
      switch (repository) {
        case ("biosamples"):
          const biosamplesService = new BiosamplesService(isaJson);
          biosamplesService.processService.addItem(document.getElementById("biosamplesloading"));
          return biosamplesService.submit(isaJson);
        case ("ENA"):
          const enaBroker = new EnaBroker(isaJson);
          enaBroker.processService.addItem(document.getElementById("ENAloading"));
          return enaBroker.submit(isaJson);
        case ("metabolights"):
          const matabolightsBroker = new MetabolightsBroker(isaJson);
          matabolightsBroker.processService.addItem(document.getElementById("metabolightsloading"));
          return matabolightsBroker.submit(isaJson);
      }
    }

    function submitAll(endRepo) {
      let repositories = [];
      for (const [index, element] of endRepo.entries()) {
        repositories.push(element.id);
        document.getElementById(`${element.id}loading`)?.addEventListener("broker", (e) => {
          if (e.detail.status === BrokerStatus.Running) {
            e.target.className = "spinner-border text-primary";
          }
          else {
            e.target.className = "spinner-border text-primary d-none";
          }
        });
      }
      // If both Biosamples and ENA are selected, submit to Biosamples first, then submit the result to ENA
      if (repositories.includes("biosamples") && repositories.includes("ENA")) {
        repositories = repositories.filter(repo => !["biosamples", "ENA"].includes(repo));
        submit("biosamples", input_json).then((updatedIsaJson) => submit("ENA", updatedIsaJson));
      }
      // Submit to the selected repositories
      for (const repository of repositories) {
        submit(repository, input_json);
      }
    }
    


  </script>
  <!-- Button trigger modal -->
  <button type="button" class="d-none btn btn-primary">
    Launch convert modal
  </button>
  <!--Modal for submission-->
  <div class="modal fade" id="cModal" tabindex="-1" data-bs-backdrop="static" aria-labelledby="cModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl modal-fullscreen-xl-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="cModalLabel">Upload to Endpoint Repositories</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="container">
            <div class="row">
              <div class="col">
                <div class="row">
                  <div class="col">
                    <div class="form-check" id="submitRepos">
                      <input class="form-check-input" type="checkbox" value="" id="biosamples" name="repo" checked>
                      <label class="form-check-label" for="biosamples">
                        BioSamples

                      </label>

                    </div>
                  </div>
                  <div class="col">
                    <div class="spinner-border text-primary d-none" id="biosamplesloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="ENA" name="repo">
                      <label class="form-check-label" for="ENA">
                        ENA
                      </label>
                    </div>
                  </div>
                  <div class="col">
                    <div class="spinner-border text-primary d-none" id="ENAloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="metabolights" name="repo">
                      <label class="form-check-label" for="metabolights">
                        Metabolites
                      </label>
                    </div>
                  </div>
                  <div class="col">
                    <div class="spinner-border text-primary d-none" id="metabolightsloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>
              </div>


            </div>
          </div>
          <table id="validate_table" class="table table-bordered table-hover">

          </table>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">download updated JSON</button>
          <button type="button" class="btn btn-primary"
            onclick="var checkedBoxes = document.querySelectorAll('input[name=repo]:checked'); submitAll(checkedBoxes)">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Button trigger modal -->
  <button type="button" class="btn btn-primary d-none" data-bs-toggle="modal" data-bs-target="#status_modal"
    id="status_modal_button">
    Show Status
  </button>

  <!-- Modal -->
  <div class="modal modal-xl fade" id="status_modal" tabindex="-1" data-bs-backdrop="static"
    aria-labelledby="status_modal_label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="status_modal_label">Status Table</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <span id="init_word"> </span>
          <br>
          <span ></span> Submission Status<br>
          
          <table id="infoTable" class="table table-bordered table-hover" style="width: 100%;">
            <thead>
              <tr>
                <th scope="col">Repositories</th>
                <th scope="col">Status</th>
                <th scope="col">Returned</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row">Token</th>
                <td id="tokenStatus">not asked</td>
                <td > <div style="overflow-wrap: break-all;
                  word-wrap: break-all;" id="tokenText"></div></td>
                <td >...</td>
              </tr>
              <tr>
                <th scope="row">ENA</th>
                <td id="enaStatus">not asked</td>
                <td ><div style="overflow-wrap: break-all;
                  word-wrap: break-all;" id="enaText"></div></td>
                <td >...</td>
              </tr>
              <tr>
                <th scope="row">BioSamples</th>
                <td id="biosamplesStatus">not asked</td>
                <td id="biosamplesText">...</td>
                <td >...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">download files</button>
          
        </div>
      </div>
    </div>
  </div>
</body>

</html>
<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="MARS: Multi-omics Adapter for Repository Submissions">
  <meta name="keywords" content="MARS,">
  <style>
    .center {
      position: relative;
      text-align: center;
    }

    .area {
      border-left: 1px solid #dee2e6;


      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;


      text-align: center;
    }

    .uploadarea {
      border: 4px dashed rgb(45, 62, 80);
      filter: alpha(opacity=50);
      -khtml-opacity: 0.5;
      -moz-opacity: 0.5;
      opacity: 0.5;
      height: 20vh;
      background-image: url("./images/download.png");
      background-position: center;
      background-repeat: no-repeat;
      background-size: 64px 64px;

    }

    .uploadarea:hover,
    .uploadarea.dragging,
    .uploadarea.uploading {
      filter: alpha(opacity=100);
      -khtml-opacity: 1;
      -moz-opacity: 1;
      opacity: 1;
    }

    .uploadarea input {
      margin: auto;
      width: 100%;
      height: 100%;

      border: none;
      cursor: pointer;
      opacity: 0;
    }

    .uploadarea input:focus {
      outline: none;
    }
  </style>

  <!--<script src="https://cdn.jsdelivr.net/pyodide/v0.21.3/full/pyodide.js"></script>-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"></script>
  <link href="css/custom.css" rel="stylesheet" />
  <link href="css/bs5-intro-tour.css" rel="stylesheet" />
  <script src="js/bs5-intro-tour.js" type="text/javascript" charset="utf-8"></script>
  <!--script src="js/example.js" type="text/javascript" charset="utf-8"></script-->
  <script src="js/test_json.js"></script>
</head>
</head>

<body>
  <div class="col-12" style="background: rgb(45, 62, 80); height: 3.25rem; margin: 0 0 0 0px; padding: 0 0 0 0; ">
    <a class="" href="https://nfdi4plants.org/" style="">
      <img src="images/logo.png" alt="Logo" width="32" height="32"
        style="position: absolute; margin: 8px 12px 8px 12px; left: 0px; padding-top: 4px;" />
    </a>





    <div class="justify-content-center row d-flex align-items-center"
      style="margin: 0 0 0 0; ; padding: 0 0 0 0; height: 3.25rem;  ">


      <div class="btn-group d-md-none g-0 dropdown col-auto d-flex align-items-center" style="">
        <button type="button" class="btn rounded-0 border-0 g-0 btn-nav " data-bs-toggle="dropdown"
          aria-expanded="false" id="menu">
          Menu &nbsp;
          <a
            style="display: inline-block; color: rgb(79, 179, 217); letter-spacing: 2px; font-size: 1em; transform: scaleX(2); transform-origin: 1 0;">
            ∨ </a>
        </button>
        <ul class="dropdown-menu">
          <li>
            <button id="converter_menu" class="dropdown-item" onclick=''>Converter</button>
          </li>
          <li>
            <button id="updater_menu" class="dropdown-item" onclick=''>Updater</button>
          </li>

        </ul>
      </div>

      <div class="btn-group d-none g-0 d-md-block dropdown col-auto">
        <button type="button" class="btn border-0 rounded-0 g-0 btn-nav" data-bs-toggle="dropdown" aria-expanded="false"
          id="conversion_tools">
          Menu &nbsp;

          <a
            style="display: inline-block; color: rgb(79, 179, 217); letter-spacing: 2px; font-size: 1em; transform: scaleX(2); transform-origin: 1 0;">
            ∨ </a>
        </button>
        <ul class="dropdown-menu">
          <li>
            <button id="converter_long" class="dropdown-item" onclick=''>Converter</button>
          </li>
          <li>
            <button id="validator_long" class="dropdown-item" onclick=''>GitHub</button>
          </li>
          <li>
            <button id="updater_long" class="dropdown-item" onclick=''>About Us</button>
          </li>

        </ul>
      </div>




    </div>
  </div>

 
  <h1 class="center"> MARS: Multiple Adatpers of Repository Submissions </h1>
  <div class="">
    
    <form id="authForm" class="row justify-content-center">
      <div class="mb-3 col-2">
        <label for="username" class="form-label">ENA Username</label>
        <input type="text" class="form-control" id="username" aria-describedby="usernameHelp">
        <div id="usernameHelp" class="form-text d-none">The user name and password are used for token generation.</div>
      </div>
      <div class="mb-3 col-2">
        <label for="password" class="form-label">Password</label>
        <input type="password" class="form-control" id="password">
      </div>
      <div class="mb-3 form-check d-none">
        <input type="checkbox" class="form-check-input " id="passwordCheck">
        <label class="form-check-label" for="passwordCheck">Check me out</label>
      </div>
      <div class="mb-3 col-2">
        <label id="tokenHelp" class="form-text">Only collect token if you need.</label>
        <br>
      <button type="submit " class="btn btn-primary" aria-describedby="tokenHelp">Collect Token</button>
      
    </div>
    </form>
  </div>
</div>
  <div class="center">

    If you want to quick try ENA submission using prepared ISA JSON, click <a href="#" onclick="test()">here</a>
    <br>
    <input class="btn btn-primary d-inline d-none" type="file" id="input_json" name="json" multiple />
    <input style="display:none" type="file" id="input_xlsx" name="xlsx" multiple />

    <div class=" area uploadarea " id="importArea" ondragenter="this.className='area uploadarea dragging'"
      ondrop=";DragAndDrop(event)" style="margin:auto; height:30vh; width:50vw">


      <input type="file" id="import" multiple>
    </div><br>
    <button class="btn btn-primary" style="display:inline" data-bs-toggle="modal" data-bs-target="#cModal"
      id="cModalButton"> Start Submissions </button>
    <div class="d-flex justify-content-center d-none" id="waiting">
      <div class="spinner-grow btn-primary" style="width: 3rem; height: 3rem;" role="status">
        <br>
        <span class="sr-only d-none">Loading...</span>
      </div>
    </div>
    <div style="margin:auto;" id="xml_output">
    </div>
  </div>
  <script type="text/javascript">
    var v_list, csv_content, cleanend_global, token , enaReturn;
    var input_json, input_xlsx;
    var log_backup = console.log;
    var log_messages = [];
    var steps = [{
      title: "Converter and validators",
      content: '<p> Welcome! Our converter can convert an ISA-JSON file to multiple endpoint repositories such as ENA, Metabolites, EGA, EVA'
      //
    }
    ];

    var tour = new Tour(steps); // initialize the guided tour
    tour.show();
    let output_div = document.getElementById("xml_output");
    function DragAndDrop(e) {
      e.preventDefault();
      let ele = document.getElementById("import");

      ele.files = e.dataTransfer.files;
      var reader = new FileReader(); // File reader to read the file 

      // This event listener will happen when the reader has read the file
      reader.addEventListener('load', function () {
        var result = JSON.parse(reader.result); // Parse the result into an object 
        //console.log("reader.result is : "+reader.result);
        input_json = result;
        //console.log("result is : " + result);
        var cleaned_data = {};
        let column_n = 0;
        let current_column_name;

      });

      reader.readAsText(ele.files[0]); // Read the uploaded file
    }
    console.log = function () {
      //log_messages.push.apply(log_messages, arguments);
      log_backup.apply(console, arguments);
      output_div.innerText = log_messages.join('\r\n');
    };
    const input1 = document.getElementById("import");
    input1.addEventListener("change", handleFiles1, false);
    function handleFiles1() {

      if (this.files.length > 0) {
        var reader = new FileReader(); // File reader to read the file 

        // This event listener will happen when the reader has read the file
        reader.addEventListener('load', function () {
          var result = JSON.parse(reader.result); // Parse the result into an object 
          //console.log("reader.result is : "+reader.result);
          input_json = result;
          //console.log("result is : " + result);
          var cleaned_data = {};
          let column_n = 0;
          let current_column_name;

        });

        reader.readAsText(this.files[0]); // Read the uploaded file





      } else {

        window.alert("no file is selected to import");

      };
    }

    function getToken(){

      document.getElementById('authForm').addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent the default form submission
      
      // Get the username and password from the input fields
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      // Construct the request body
      var requestBody = {
        authRealms: ['ENA'],
        password: password,
        username: username
      };
      
      // Send the POST request using Fetch API
      fetch('https://www.ebi.ac.uk/ena/submit/webin/auth/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      })
      .then((response) => response.text())
      .then(text => {
        console.log('Response:', text);
        token = text;
        document.getElementById("tokenText").innerText=token;
        document.getElementById("tokenStatus").innerText="Returned";
        document.getElementById("status_modal_button").click();
        // Handle the response here
      })
      .catch(error => {
        console.error('Error:', error);
        // Handle errors here
      });
    });
  }


    async function main(input_json) {

      if (input_json === undefined || input_json.length < 0) {
        window.alert("please select an lister json file to be imported")
      } else {

        document.getElementById("waiting").classList.remove("d-none");



        var saveData = (function () {
          var a = document.createElement("a");
          document.body.appendChild(a);
          a.style = "display: none";
          return function (data, fileName) {
            blob = new Blob([data], { type: "octet/stream" }),
              url = window.URL.createObjectURL(blob);
            a.href = url;
            a.download = fileName;
            a.click();
            window.URL.revokeObjectURL(url);
          };
        }()
        );




        var data = JSON.stringify(input_json),
          fileName = "inv.json";

        saveData(data, fileName);
        //let file = pyodide.FS.readFile("SAMPLE.XML", { encoding: "utf8" });
        //output_div.innerText = file;
        document.getElementById("waiting").classList.add("d-none");



      }

    };
    window.onload = (event) =>{

      getToken();

    }

    function test(){
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      enaSubmit(username, password, testJSON)

    }
  </script>
  <script type="module">
    import { EnaBroker } from "./js/broker/ena/ena.broker.js";
    import { MetabolightsBroker } from "./js/broker/metabolights/metabolights.broker.js";
    import { BiosamplesService } from "./js/broker/biosamples/biosamples.service.js";
    import { BrokerType } from "./js/broker/broker.type.js";
    import { BrokerStatus } from "./js/broker/status.type.js";

    function submit(repository, isaJson) {
      switch (repository) {
        case ("biosamples"):
          const biosamplesService = new BiosamplesService(isaJson);
          biosamplesService.processService.addItem(document.getElementById("biosamplesloading"));
          return biosamplesService.submit(isaJson);
        case ("ENA"):
          const enaBroker = new EnaBroker(isaJson);
          enaBroker.processService.addItem(document.getElementById("ENAloading"));
          return enaBroker.submit(isaJson);
        case ("metabolights"):
          const matabolightsBroker = new MetabolightsBroker(isaJson);
          matabolightsBroker.processService.addItem(document.getElementById("metabolightsloading"));
          return matabolightsBroker.submit(isaJson);
      }
    }

    function submitAll(endRepo) {
      let repositories = [];
      for (const [index, element] of endRepo.entries()) {
        repositories.push(element.id);
        document.getElementById(`${element.id}loading`)?.addEventListener("broker", (e) => {
          if (e.detail.status === BrokerStatus.Running) {
            e.target.className = "spinner-border text-primary";
          }
          else {
            e.target.className = "spinner-border text-primary d-none";
          }
        });
      }
      // If both Biosamples and ENA are selected, submit to Biosamples first, then submit the result to ENA
      if (repositories.includes("biosamples") && repositories.includes("ENA")) {
        repositories = repositories.filter(repo => !["biosamples", "ENA"].includes(repo));
        submit("biosamples", input_json).then((updatedIsaJson) => submit("ENA", updatedIsaJson));
      }
      // Submit to the selected repositories
      for (const repository of repositories) {
        submit(repository, input_json);
      }
    }
    window.submitAll = submitAll;


  </script>
  <!-- Button trigger modal -->
  <button type="button" class="d-none btn btn-primary">
    Launch convert modal
  </button>
  <!--Modal for submission-->
  <div class="modal fade" id="cModal" tabindex="-1" data-bs-backdrop="static" aria-labelledby="cModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl modal-fullscreen-xl-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="cModalLabel">Upload to Endpoint Repositories</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="container">
            <div class="row">
              <div class="col">
                <div class="row">
                  <div class="col">
                    <div class="form-check" id="submitRepos">
                      <input class="form-check-input" type="checkbox" value="" id="biosamples" name="repo" checked>
                      <label class="form-check-label" for="biosamples">
                        BioSamples

                      </label>

                    </div>
                  </div>
                  <div class="col">
                    <div class="spinner-border text-primary d-none" id="biosamplesloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="ENA" name="repo">
                      <label class="form-check-label" for="ENA">
                        ENA
                      </label>
                    </div>
                  </div>
                  <div class="col">
                    <div class="spinner-border text-primary d-none" id="ENAloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="metabolights" name="repo">
                      <label class="form-check-label" for="metabolights">
                        Metabolites
                      </label>
                    </div>
                  </div>
                  <div class="col">
                    <div class="spinner-border text-primary d-none" id="metabolightsloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>
              </div>


            </div>
          </div>
          <table id="validate_table" class="table table-bordered table-hover">

          </table>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">download updated JSON</button>
          <button type="button" class="btn btn-primary"
            onclick="var checkedBoxes = document.querySelectorAll('input[name=repo]:checked'); submitAll(checkedBoxes)">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Button trigger modal -->
  <button type="button" class="btn btn-primary d-none" data-bs-toggle="modal" data-bs-target="#status_modal"
    id="status_modal_button">
    Show Status
  </button>

  <!-- Modal -->
  <div class="modal modal-xl fade" id="status_modal" tabindex="-1" data-bs-backdrop="static"
    aria-labelledby="status_modal_label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="status_modal_label">Status Table</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <span id="init_word"> </span>
          <br>
          <span ></span>Submision Status<br>
          
          <table id="infoTable" class="table table-bordered table-hover" style="width: 100%;">
            <thead>
              <tr>
                <th scope="col">Repositories</th>
                <th scope="col">Status</th>
                <th scope="col">Returned</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row">Token</th>
                <td id="tokenStatus">not asked</td>
                <td > <div style="overflow-wrap: break-all;
                  word-wrap: break-all;" id="tokenText"></div></td>
                <td >...</td>
              </tr>
              <tr>
                <th scope="row">ENA</th>
                <td id="enaStatus">not asked</td>
                <td ><div style="overflow-wrap: break-all;
                  word-wrap: break-all;" id="enaText"></div></td>
                <td >...</td>
              </tr>
              <tr>
                <th scope="row">BioSamples</th>
                <td >not asked</td>
                <td >...</td>
                <td >...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">download files</button>
          
        </div>
      </div>
    </div>
  </div>
</body>

</html>